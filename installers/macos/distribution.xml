<?xml version="1.0" encoding="utf-8"?>
<installer-gui-script minSpecVersion="2">
    <title>Allow2 Automate Agent</title>
    <organization>com.allow2</organization>
    <domains enable_localSystem="true"/>
    <options customize="never" require-scripts="true" rootVolumeOnly="true" allow-external-scripts="yes" />

    <!-- Welcome message -->
    <welcome file="welcome.html"/>

    <!-- README with installation instructions -->
    <readme file="readme.html"/>

    <!-- Choices outline -->
    <choices-outline>
        <line choice="default">
            <line choice="com.allow2.automate-agent"/>
        </line>
    </choices-outline>

    <choice id="default"/>

    <choice id="com.allow2.automate-agent" visible="false">
        <pkg-ref id="com.allow2.automate-agent"/>
    </choice>

    <pkg-ref id="com.allow2.automate-agent" version="0" onConclusion="none">
        allow2automate-agent-component.pkg
    </pkg-ref>

    <!--
        JavaScript runs in Installer.app context (not sandboxed like shell scripts).
        This copies the config file to /tmp where preinstall can access it.

        Note: The macOS Installer JS API is very limited. We use system.run() to
        execute shell commands for most operations.
    -->
    <script>
<![CDATA[
function installation_check() {
    var configName = "allow2automate-agent-config.json";
    var tempDir = "/tmp/allow2-installer";
    var tempConfig = tempDir + "/config.json";

    system.log("Allow2 Installer: Starting installation check");

    // Create temp directory
    system.run('/bin/mkdir', '-p', tempDir);

    // Find the PKG path using lsof and look for config in same directory
    var scriptResult = system.run('/bin/bash', '-c',
        'CONFIG_NAME="' + configName + '"; ' +
        'TEMP_CONFIG="' + tempConfig + '"; ' +

        // Find the PKG path from Installer process
        'PKG_PATH=$(lsof -c Installer 2>/dev/null | grep "\\.pkg$" | awk \\''{print $NF}\\'' | head -1); ' +
        'if [ -z "$PKG_PATH" ]; then ' +
        '  echo "Could not find PKG path" >&2; ' +
        '  exit 3; ' +
        'fi; ' +

        // Get directory containing the PKG
        'PKG_DIR=$(dirname "$PKG_PATH"); ' +
        'CONFIG_PATH="$PKG_DIR/$CONFIG_NAME"; ' +
        'echo "Looking for config at: $CONFIG_PATH" >&2; ' +

        // Check if config exists and copy it
        'if [ -f "$CONFIG_PATH" ]; then ' +
        '  cp "$CONFIG_PATH" "$TEMP_CONFIG" && chmod 644 "$TEMP_CONFIG" && exit 0; ' +
        '  exit 2; ' +
        'fi; ' +
        'exit 1'
    );

    system.log("Allow2 Installer: Script result = " + scriptResult);

    if (scriptResult == 3) {
        system.log("Allow2 Installer: ERROR - Could not determine installer location");
        my.result.type = 'Fatal';
        my.result.title = 'Installation Error';
        my.result.message = 'Could not determine the installer package location.\n\n' +
            'Please try running the installer again.';
        return false;
    }

    if (scriptResult == 1) {
        system.log("Allow2 Installer: ERROR - Config file not found");
        my.result.type = 'Fatal';
        my.result.title = 'Configuration File Required';
        my.result.message = 'The configuration file "' + configName + '" was not found in the same folder as the installer.\n\n' +
            'Please ensure the configuration file is in the same folder as the .pkg installer.\n\n' +
            'You can download the configuration file from the Allow2 Automate parent application.';
        return false;
    }

    if (scriptResult == 2) {
        system.log("Allow2 Installer: ERROR - Failed to copy config file");
        my.result.type = 'Fatal';
        my.result.title = 'Configuration Error';
        my.result.message = 'Found the configuration file but could not copy it.\n\n' +
            'Please check file permissions and try again.';
        return false;
    }

    if (scriptResult != 0) {
        system.log("Allow2 Installer: ERROR - Unknown error (code " + scriptResult + ")");
        my.result.type = 'Fatal';
        my.result.title = 'Installation Error';
        my.result.message = 'An unexpected error occurred while preparing the configuration.\n\n' +
            'Error code: ' + scriptResult;
        return false;
    }

    system.log("Allow2 Installer: Config prepared successfully");
    return true;
}
]]>
    </script>

    <installation-check script="installation_check()"/>

</installer-gui-script>
