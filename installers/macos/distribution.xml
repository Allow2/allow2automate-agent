<?xml version="1.0" encoding="utf-8"?>
<installer-gui-script minSpecVersion="2">
    <title>Allow2 Automate Agent</title>
    <organization>com.allow2</organization>
    <domains enable_localSystem="true"/>
    <options customize="never" require-scripts="true" rootVolumeOnly="true" allow-external-scripts="yes" />

    <!-- Welcome message -->
    <welcome file="welcome.html"/>

    <!-- README with installation instructions -->
    <readme file="readme.html"/>

    <!-- Choices outline -->
    <choices-outline>
        <line choice="default">
            <line choice="com.allow2.automate-agent"/>
        </line>
    </choices-outline>

    <choice id="default"/>

    <choice id="com.allow2.automate-agent" visible="false">
        <pkg-ref id="com.allow2.automate-agent"/>
    </choice>

    <pkg-ref id="com.allow2.automate-agent" version="0" onConclusion="none">
        allow2automate-agent-component.pkg
    </pkg-ref>

    <!--
        JavaScript runs in Installer.app context (not sandboxed like shell scripts).
        This copies the config file to /tmp where preinstall can access it.

        Note: The macOS Installer JS API is very limited. We use system.run() to
        execute shell commands for most operations.
    -->
    <!--
        DMG-BASED INSTALLATION APPROACH
        ================================
        This installer expects to be run from a mounted DMG volume that contains
        both the PKG installer and the config file. This is the standard approach
        for macOS installers that need external configuration files.

        Why DMG? macOS TCC (Transparency, Consent, and Control) prevents installer
        scripts from reading files in user directories like ~/Downloads. However,
        mounted volumes (/Volumes/*) are NOT subject to TCC restrictions.

        The search order is:
        1. Mounted volumes (/Volumes/*) - NOT TCC restricted, preferred
        2. /tmp - accessible by preinstall, user can copy here manually
        3. User directories - may fail due to TCC (fallback only)

        JavaScript runs in Installer.app context (not sandboxed like preinstall).
        This copies the config file to /tmp where preinstall can access it.
    -->
    <script>
<![CDATA[
function installation_check() {
    var configName = "allow2automate-agent-config.json";
    var tempConfig = "/tmp/" + configName;
    var debugLog = "/tmp/allow2-installer-debug.log";

    system.log("Allow2 Installer: Starting installation check");

    // ALWAYS search for fresh config from DMG - don't trust stale files in /tmp
    // This ensures we use the config bundled with THIS installer, not a leftover from a previous attempt
    var scriptResult = system.run('/bin/bash', '-c',
        'CONFIG_NAME="' + configName + '"; ' +
        'TEMP_CONFIG="' + tempConfig + '"; ' +
        'DEBUG_LOG="' + debugLog + '"; ' +

        // Create debug log
        'echo "=== Allow2 Installer Debug Log ===" > "$DEBUG_LOG"; ' +
        'echo "Date: $(date)" >> "$DEBUG_LOG"; ' +
        'echo "Looking for: $CONFIG_NAME" >> "$DEBUG_LOG"; ' +

        'CONFIG_PATH=""; ' +

        // PRIORITY 1: Check mounted volumes FIRST (NO TCC RESTRICTIONS!)
        // This is the recommended approach - user opens DMG containing pkg + config
        'echo "=== Checking mounted volumes (preferred) ===" >> "$DEBUG_LOG"; ' +
        'for vol in /Volumes/*; do ' +
        '  if [ -d "$vol" ] && [ -f "$vol/$CONFIG_NAME" ]; then ' +
        '    CONFIG_PATH="$vol/$CONFIG_NAME"; ' +
        '    echo "✅ Found in mounted volume: $vol" >> "$DEBUG_LOG"; ' +
        '    break; ' +
        '  fi; ' +
        'done; ' +

        // PRIORITY 2: Check /tmp (user may have manually copied here)
        'if [ -z "$CONFIG_PATH" ] && [ -f "/tmp/$CONFIG_NAME" ]; then ' +
        '  CONFIG_PATH="/tmp/$CONFIG_NAME"; ' +
        '  echo "✅ Found in /tmp" >> "$DEBUG_LOG"; ' +
        'fi; ' +

        // PRIORITY 3: Check directory where pkg is located (may work for standalone pkg)
        'if [ -z "$CONFIG_PATH" ]; then ' +
        '  echo "Trying to find pkg location via lsof..." >> "$DEBUG_LOG"; ' +
        '  PKG_PATH=$(lsof -c Installer 2>/dev/null | grep -E "\\.pkg" | awk "{print \\$NF}" | grep -v "^$" | head -1); ' +
        '  if [ -n "$PKG_PATH" ]; then ' +
        '    PKG_DIR=$(dirname "$PKG_PATH"); ' +
        '    echo "PKG directory: $PKG_DIR" >> "$DEBUG_LOG"; ' +
        '    if [ -f "$PKG_DIR/$CONFIG_NAME" ]; then ' +
        '      CONFIG_PATH="$PKG_DIR/$CONFIG_NAME"; ' +
        '      echo "✅ Found next to pkg: $PKG_DIR" >> "$DEBUG_LOG"; ' +
        '    fi; ' +
        '  fi; ' +
        'fi; ' +

        // PRIORITY 4: User directories (MAY FAIL DUE TO TCC - last resort)
        'if [ -z "$CONFIG_PATH" ]; then ' +
        '  echo "=== Trying user directories (may fail due to TCC) ===" >> "$DEBUG_LOG"; ' +
        '  CURRENT_USER=$(stat -f "%Su" /dev/console 2>/dev/null || echo "$USER"); ' +
        '  echo "Current user: $CURRENT_USER" >> "$DEBUG_LOG"; ' +
        '  for loc in "/Users/$CURRENT_USER/Downloads" "/Users/$CURRENT_USER/Desktop" "/Users/$CURRENT_USER"; do ' +
        '    if [ -f "$loc/$CONFIG_NAME" ]; then ' +
        '      CONFIG_PATH="$loc/$CONFIG_NAME"; ' +
        '      echo "Found (may not be readable): $loc" >> "$DEBUG_LOG"; ' +
        '      break; ' +
        '    fi; ' +
        '  done; ' +
        'fi; ' +

        'echo "" >> "$DEBUG_LOG"; ' +
        'echo "Final CONFIG_PATH: $CONFIG_PATH" >> "$DEBUG_LOG"; ' +

        // If not found anywhere, exit with error 1
        'if [ -z "$CONFIG_PATH" ]; then ' +
        '  echo "❌ Config file not found anywhere" >> "$DEBUG_LOG"; ' +
        '  exit 1; ' +
        'fi; ' +

        // Try to copy the config file to /tmp
        'echo "Attempting to copy from: $CONFIG_PATH" >> "$DEBUG_LOG"; ' +
        'if cat "$CONFIG_PATH" > "$TEMP_CONFIG" 2>> "$DEBUG_LOG" && chmod 644 "$TEMP_CONFIG"; then ' +
        '  echo "✅ Successfully copied config to $TEMP_CONFIG" >> "$DEBUG_LOG"; ' +
        '  exit 0; ' +
        'else ' +
        '  echo "❌ Failed to copy config file (TCC restriction?)" >> "$DEBUG_LOG"; ' +
        '  exit 2; ' +
        'fi'
    );

    system.log("Allow2 Installer: Script result = " + scriptResult);

    if (scriptResult == 0) {
        system.log("Allow2 Installer: Config prepared successfully");
        return true;
    }

    if (scriptResult == 1) {
        system.log("Allow2 Installer: ERROR - Config file not found");
        my.result.type = 'Fatal';
        my.result.title = 'Configuration File Required';
        my.result.message = 'The configuration file "' + configName + '" was not found.\n\n' +
            'RECOMMENDED: Download the DMG installer which includes both\n' +
            'the installer and a place for your configuration file.\n\n' +
            'Or manually copy your config file to /tmp:\n' +
            '  cp ~/Downloads/' + configName + ' /tmp/\n\n' +
            'Then run this installer again.\n\n' +
            '(Debug log: /tmp/allow2-installer-debug.log)';
        return false;
    }

    if (scriptResult == 2) {
        system.log("Allow2 Installer: ERROR - Failed to copy config (TCC?)");
        my.result.type = 'Fatal';
        my.result.title = 'Configuration Error - macOS Security Restriction';
        my.result.message = 'Found the configuration file but macOS security\n' +
            'prevented reading it from that location.\n\n' +
            'SOLUTION: Copy the config file to /tmp first:\n\n' +
            '  cp ~/Downloads/' + configName + ' /tmp/\n\n' +
            'Then run this installer again.\n\n' +
            'Or use the DMG installer which avoids this issue.\n\n' +
            '(Debug log: /tmp/allow2-installer-debug.log)';
        return false;
    }

    // Unknown error
    system.log("Allow2 Installer: ERROR - Unknown error (code " + scriptResult + ")");
    my.result.type = 'Fatal';
    my.result.title = 'Installation Error';
    my.result.message = 'An unexpected error occurred (code ' + scriptResult + ').\n\n' +
        '(Debug log: /tmp/allow2-installer-debug.log)';
    return false;
}
]]>
    </script>

    <installation-check script="installation_check()"/>

</installer-gui-script>
