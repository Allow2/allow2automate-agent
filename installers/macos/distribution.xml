<?xml version="1.0" encoding="utf-8"?>
<installer-gui-script minSpecVersion="2">
    <title>Allow2 Automate Agent</title>
    <organization>com.allow2</organization>
    <domains enable_localSystem="true"/>
    <options customize="never" require-scripts="true" rootVolumeOnly="true" allow-external-scripts="yes" />

    <!-- Welcome message -->
    <welcome file="welcome.html"/>

    <!-- README with installation instructions -->
    <readme file="readme.html"/>

    <!-- Choices outline -->
    <choices-outline>
        <line choice="default">
            <line choice="com.allow2.automate-agent"/>
        </line>
    </choices-outline>

    <choice id="default"/>

    <choice id="com.allow2.automate-agent" visible="false">
        <pkg-ref id="com.allow2.automate-agent"/>
    </choice>

    <pkg-ref id="com.allow2.automate-agent" version="0" onConclusion="none">
        allow2automate-agent-component.pkg
    </pkg-ref>

    <!--
        JavaScript runs in Installer.app context (not sandboxed like shell scripts).
        This copies the config file to /tmp where preinstall can access it.

        Note: The macOS Installer JS API is very limited. We use system.run() to
        execute shell commands for most operations.
    -->
    <script>
<![CDATA[
function installation_check() {
    var configName = "allow2automate-agent-config.json";
    var tempDir = "/var/tmp/allow2-installer";
    var tempConfig = tempDir + "/config.json";

    system.log("Allow2 Installer: Starting installation check");

    // First, check if config was already copied (handles re-runs after first script approval)
    var alreadyExists = system.run('/bin/bash', '-c',
        '[ -f "' + tempConfig + '" ] && exit 0 || exit 1'
    );

    if (alreadyExists == 0) {
        system.log("Allow2 Installer: Config already prepared from previous check");
        return true;
    }

    // Config not yet copied - search for it in common locations
    // The script searches multiple locations where the config might be
    var scriptResult = system.run('/bin/bash', '-c',
        'CONFIG_NAME="' + configName + '"; ' +
        'TEMP_DIR="' + tempDir + '"; ' +
        'TEMP_CONFIG="' + tempConfig + '"; ' +
        'DEBUG_LOG="$TEMP_DIR/debug.log"; ' +

        // Create temp directory
        'mkdir -p "$TEMP_DIR" || exit 4; ' +
        'echo "=== Allow2 Installer Debug Log ===" > "$DEBUG_LOG"; ' +
        'echo "Date: $(date)" >> "$DEBUG_LOG"; ' +
        'echo "Looking for: $CONFIG_NAME" >> "$DEBUG_LOG"; ' +

        // Get current user for searching their directories
        'CURRENT_USER=$(stat -f "%Su" /dev/console 2>/dev/null || echo "$USER"); ' +
        'echo "Current user: $CURRENT_USER" >> "$DEBUG_LOG"; ' +

        // Search for config file directly in common locations
        'CONFIG_PATH=""; ' +

        // Check Downloads folder
        'if [ -z "$CONFIG_PATH" ] && [ -f "/Users/$CURRENT_USER/Downloads/$CONFIG_NAME" ]; then ' +
        '  CONFIG_PATH="/Users/$CURRENT_USER/Downloads/$CONFIG_NAME"; ' +
        '  echo "Found in Downloads" >> "$DEBUG_LOG"; ' +
        'fi; ' +

        // Check Desktop
        'if [ -z "$CONFIG_PATH" ] && [ -f "/Users/$CURRENT_USER/Desktop/$CONFIG_NAME" ]; then ' +
        '  CONFIG_PATH="/Users/$CURRENT_USER/Desktop/$CONFIG_NAME"; ' +
        '  echo "Found on Desktop" >> "$DEBUG_LOG"; ' +
        'fi; ' +

        // Check home directory
        'if [ -z "$CONFIG_PATH" ] && [ -f "/Users/$CURRENT_USER/$CONFIG_NAME" ]; then ' +
        '  CONFIG_PATH="/Users/$CURRENT_USER/$CONFIG_NAME"; ' +
        '  echo "Found in home dir" >> "$DEBUG_LOG"; ' +
        'fi; ' +

        // Check /tmp
        'if [ -z "$CONFIG_PATH" ] && [ -f "/tmp/$CONFIG_NAME" ]; then ' +
        '  CONFIG_PATH="/tmp/$CONFIG_NAME"; ' +
        '  echo "Found in /tmp" >> "$DEBUG_LOG"; ' +
        'fi; ' +

        // Try to find via lsof (may work sometimes)
        'if [ -z "$CONFIG_PATH" ]; then ' +
        '  echo "Trying lsof method..." >> "$DEBUG_LOG"; ' +
        '  PKG_PATH=$(lsof -c Installer 2>/dev/null | grep -E "\\.pkg" | awk "{print \\$NF}" | grep -v "^$" | head -1); ' +
        '  echo "lsof PKG_PATH: $PKG_PATH" >> "$DEBUG_LOG"; ' +
        '  if [ -n "$PKG_PATH" ] && [ -f "$PKG_PATH" ]; then ' +
        '    PKG_DIR=$(dirname "$PKG_PATH"); ' +
        '    if [ -f "$PKG_DIR/$CONFIG_NAME" ]; then ' +
        '      CONFIG_PATH="$PKG_DIR/$CONFIG_NAME"; ' +
        '      echo "Found via lsof in: $PKG_DIR" >> "$DEBUG_LOG"; ' +
        '    fi; ' +
        '  fi; ' +
        'fi; ' +

        // Search in mounted volumes (for DMG-based installs)
        'if [ -z "$CONFIG_PATH" ]; then ' +
        '  echo "Checking mounted volumes..." >> "$DEBUG_LOG"; ' +
        '  for vol in /Volumes/*; do ' +
        '    if [ -f "$vol/$CONFIG_NAME" ]; then ' +
        '      CONFIG_PATH="$vol/$CONFIG_NAME"; ' +
        '      echo "Found in volume: $vol" >> "$DEBUG_LOG"; ' +
        '      break; ' +
        '    fi; ' +
        '  done; ' +
        'fi; ' +

        // Use find as last resort (search user directories)
        'if [ -z "$CONFIG_PATH" ]; then ' +
        '  echo "Using find as fallback..." >> "$DEBUG_LOG"; ' +
        '  CONFIG_PATH=$(find /Users/$CURRENT_USER -maxdepth 3 -name "$CONFIG_NAME" -type f 2>/dev/null | head -1); ' +
        '  if [ -n "$CONFIG_PATH" ]; then ' +
        '    echo "Found via find: $CONFIG_PATH" >> "$DEBUG_LOG"; ' +
        '  fi; ' +
        'fi; ' +

        'echo "Final CONFIG_PATH: $CONFIG_PATH" >> "$DEBUG_LOG"; ' +

        // If still not found, exit with error
        'if [ -z "$CONFIG_PATH" ] || [ ! -f "$CONFIG_PATH" ]; then ' +
        '  echo "Config file not found anywhere" >> "$DEBUG_LOG"; ' +
        '  exit 1; ' +
        'fi; ' +

        // Copy the config file
        'if cat "$CONFIG_PATH" > "$TEMP_CONFIG" && chmod 644 "$TEMP_CONFIG"; then ' +
        '  echo "Successfully copied config to $TEMP_CONFIG" >> "$DEBUG_LOG"; ' +
        '  exit 0; ' +
        'else ' +
        '  echo "Failed to copy config file" >> "$DEBUG_LOG"; ' +
        '  exit 2; ' +
        'fi'
    );

    system.log("Allow2 Installer: Script result = " + scriptResult);

    if (scriptResult == 4) {
        system.log("Allow2 Installer: ERROR - Could not create temp directory");
        my.result.type = 'Fatal';
        my.result.title = 'Installation Error';
        my.result.message = 'Could not create temporary directory.\n\n' +
            'Please check disk permissions and try again.';
        return false;
    }

    if (scriptResult == 1) {
        system.log("Allow2 Installer: ERROR - Config file not found");
        my.result.type = 'Fatal';
        my.result.title = 'Configuration File Required';
        my.result.message = 'The configuration file "' + configName + '" was not found.\n\n' +
            'Please place the configuration file in one of these locations:\n' +
            '• Downloads folder\n' +
            '• Desktop\n' +
            '• Same folder as the installer\n\n' +
            'You can download the configuration file from the Allow2 Automate parent application.\n\n' +
            '(Debug log: /var/tmp/allow2-installer/debug.log)';
        return false;
    }

    if (scriptResult == 2) {
        system.log("Allow2 Installer: ERROR - Failed to copy config file");
        my.result.type = 'Fatal';
        my.result.title = 'Configuration Error';
        my.result.message = 'Found the configuration file but could not copy it.\n\n' +
            'Please check file permissions and try again.\n\n' +
            '(Debug log: /var/tmp/allow2-installer/debug.log)';
        return false;
    }

    if (scriptResult != 0) {
        system.log("Allow2 Installer: ERROR - Unknown error (code " + scriptResult + ")");
        my.result.type = 'Fatal';
        my.result.title = 'Installation Error';
        my.result.message = 'An unexpected error occurred while preparing the configuration.\n\n' +
            'Error code: ' + scriptResult + '\n\n' +
            '(Debug log: /var/tmp/allow2-installer/debug.log)';
        return false;
    }

    system.log("Allow2 Installer: Config prepared successfully");
    return true;
}
]]>
    </script>

    <installation-check script="installation_check()"/>

</installer-gui-script>
