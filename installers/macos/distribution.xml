<?xml version="1.0" encoding="utf-8"?>
<installer-gui-script minSpecVersion="2">
    <title>Allow2 Automate Agent</title>
    <organization>com.allow2</organization>
    <domains enable_localSystem="true"/>
    <options customize="never" require-scripts="true" rootVolumeOnly="true" />

    <!-- Welcome message -->
    <welcome file="welcome.html"/>

    <!-- README with installation instructions -->
    <readme file="readme.html"/>

    <!-- Choices outline -->
    <choices-outline>
        <line choice="default">
            <line choice="com.allow2.automate-agent"/>
        </line>
    </choices-outline>

    <choice id="default"/>

    <choice id="com.allow2.automate-agent" visible="false">
        <pkg-ref id="com.allow2.automate-agent"/>
    </choice>

    <pkg-ref id="com.allow2.automate-agent" version="0" onConclusion="none">
        allow2automate-agent-component.pkg
    </pkg-ref>

    <!--
        JavaScript runs in Installer.app context (not sandboxed like shell scripts).
        This copies the config file to /tmp where preinstall can access it.

        Note: The macOS Installer JS API is very limited. We use system.run() to
        execute shell commands for most operations.
    -->
    <script>
<![CDATA[
function installation_check() {
    // This runs BEFORE installation begins, with user-level permissions
    var configName = "allow2automate-agent-config.json";
    var tempDir = "/tmp/allow2-installer";
    var tempConfig = tempDir + "/config.json";

    system.log("Allow2 Installer: Starting installation check");

    // Create temp directory
    system.run('/bin/mkdir', '-p', tempDir);

    // Use a shell script to find and copy the config file
    // This runs with user permissions and can access user directories
    var scriptResult = system.run('/bin/bash', '-c',
        'CONFIG_NAME="' + configName + '"; ' +
        'TEMP_CONFIG="' + tempConfig + '"; ' +
        'HOME_DIR="$HOME"; ' +

        // Search locations in order of preference
        'SEARCH_PATHS=( ' +
        '  "/tmp/$CONFIG_NAME" ' +
        '  "$HOME_DIR/Downloads/$CONFIG_NAME" ' +
        '  "$HOME_DIR/Desktop/$CONFIG_NAME" ' +
        '  "$HOME_DIR/$CONFIG_NAME" ' +
        '); ' +

        // Also search any Allow2* volumes
        'for vol in /Volumes/Allow2*; do ' +
        '  if [ -d "$vol" ]; then ' +
        '    SEARCH_PATHS+=("$vol/$CONFIG_NAME"); ' +
        '  fi; ' +
        'done; ' +

        // Also check Downloads subdirectories (where PKG might be extracted)
        'for dir in "$HOME_DIR/Downloads"/*; do ' +
        '  if [ -d "$dir" ] && [ -f "$dir/$CONFIG_NAME" ]; then ' +
        '    SEARCH_PATHS+=("$dir/$CONFIG_NAME"); ' +
        '  fi; ' +
        'done; ' +

        // Find and copy the config
        'FOUND=""; ' +
        'for path in "${SEARCH_PATHS[@]}"; do ' +
        '  if [ -f "$path" ]; then ' +
        '    FOUND="$path"; ' +
        '    break; ' +
        '  fi; ' +
        'done; ' +

        // If found, copy to temp
        'if [ -n "$FOUND" ]; then ' +
        '  cp "$FOUND" "$TEMP_CONFIG" && chmod 644 "$TEMP_CONFIG" && exit 0; ' +
        '  exit 2; ' +  // Copy failed
        'fi; ' +
        'exit 1'  // Not found
    );

    system.log("Allow2 Installer: Script result = " + scriptResult);

    if (scriptResult == 1) {
        // Config not found
        system.log("Allow2 Installer: ERROR - Config file not found");
        my.result.type = 'Fatal';
        my.result.title = 'Configuration File Required';
        my.result.message = 'The configuration file "' + configName + '" was not found.\n\n' +
            'Please place the configuration file in your Downloads folder, ' +
            'or in the same folder as this installer package.\n\n' +
            'You can download the configuration file from the Allow2 Automate parent application.';
        return false;
    }

    if (scriptResult == 2) {
        // Copy failed
        system.log("Allow2 Installer: ERROR - Failed to copy config file");
        my.result.type = 'Fatal';
        my.result.title = 'Configuration Error';
        my.result.message = 'Found the configuration file but could not copy it.\n\n' +
            'Please check file permissions and try again.';
        return false;
    }

    if (scriptResult != 0) {
        // Unknown error
        system.log("Allow2 Installer: ERROR - Unknown error (code " + scriptResult + ")");
        my.result.type = 'Fatal';
        my.result.title = 'Installation Error';
        my.result.message = 'An unexpected error occurred while preparing the configuration.\n\n' +
            'Error code: ' + scriptResult;
        return false;
    }

    system.log("Allow2 Installer: Config prepared successfully");
    return true;
}
]]>
    </script>

    <installation-check script="installation_check()"/>

</installer-gui-script>
