#!/bin/sh
# Allow2Automate Agent Universal Installer
# Generated by Allow2Automate parent app
#
# This script will:
# 1. Detect your Linux distribution
# 2. Download the correct package (.deb or .rpm) from GitHub
# 3. Install it using your native package manager
# 4. Write the embedded configuration
# 5. Start the agent service
#
# Usage: sudo sh install-allow2-agent.sh
#
# Supports: Ubuntu, Debian, Mint, Pop!_OS, Fedora, RHEL, CentOS, Rocky,
#           AlmaLinux, openSUSE, and derivatives

set -e

#=============================================================================
# EMBEDDED CONFIGURATION (generated by Allow2Automate parent app)
# DO NOT EDIT - This section is auto-generated with your agent credentials
#=============================================================================
AGENT_CONFIG='__AGENT_CONFIG_PLACEHOLDER__'
VERSION="__VERSION_PLACEHOLDER__"
#=============================================================================

REPO="Allow2/allow2automate-agent"
GITHUB_RELEASES="https://github.com/${REPO}/releases/download"

# Terminal colors (disabled if not a tty)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

log()   { printf "${GREEN}[Allow2]${NC} %s\n" "$1"; }
warn()  { printf "${YELLOW}[Allow2]${NC} %s\n" "$1"; }
error() { printf "${RED}[Allow2]${NC} ERROR: %s\n" "$1"; exit 1; }
info()  { printf "${BLUE}[Allow2]${NC} %s\n" "$1"; }

#=============================================================================
# Pre-flight checks
#=============================================================================

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        error "This script must be run as root. Please use: sudo sh $0"
    fi
}

check_systemd() {
    if ! command -v systemctl >/dev/null 2>&1; then
        error "systemd is required but not found. This script supports systemd-based distributions only."
    fi
}

check_download_tool() {
    if command -v curl >/dev/null 2>&1; then
        DOWNLOAD_TOOL="curl"
        DOWNLOAD_CMD="curl -fsSL -o"
    elif command -v wget >/dev/null 2>&1; then
        DOWNLOAD_TOOL="wget"
        DOWNLOAD_CMD="wget -q -O"
    else
        error "Neither curl nor wget found. Please install one:\n  apt install curl   # Debian/Ubuntu\n  dnf install curl   # Fedora/RHEL"
    fi
    log "Using $DOWNLOAD_TOOL for downloads"
}

#=============================================================================
# Distribution Detection
#=============================================================================

detect_distro() {
    DISTRO=""
    DISTRO_LIKE=""
    DISTRO_VERSION=""

    # Primary method: /etc/os-release (most modern distros)
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        DISTRO="$ID"
        DISTRO_LIKE="$ID_LIKE"
        DISTRO_VERSION="$VERSION_ID"
    # Fallback: lsb_release
    elif command -v lsb_release >/dev/null 2>&1; then
        DISTRO=$(lsb_release -si | tr '[:upper:]' '[:lower:]')
        DISTRO_VERSION=$(lsb_release -sr)
    # Last resort: check for specific files
    elif [ -f /etc/debian_version ]; then
        DISTRO="debian"
    elif [ -f /etc/redhat-release ]; then
        DISTRO="rhel"
    else
        DISTRO="unknown"
    fi

    log "Detected distribution: $DISTRO (version: ${DISTRO_VERSION:-unknown})"
    [ -n "$DISTRO_LIKE" ] && info "Distribution family: $DISTRO_LIKE"
}

#=============================================================================
# Package Manager Detection
#=============================================================================

detect_package_manager() {
    PKG_FORMAT=""
    PKG_MANAGER=""
    INSTALL_CMD=""

    case "$DISTRO" in
        # Debian family
        ubuntu|debian|linuxmint|pop|elementary|zorin|kali|raspbian|neon|deepin|parrot)
            PKG_FORMAT="deb"
            PKG_MANAGER="apt"
            INSTALL_CMD="dpkg -i"
            INSTALL_DEPS_CMD="apt-get install -f -y"
            ;;
        # Red Hat family
        fedora)
            PKG_FORMAT="rpm"
            PKG_MANAGER="dnf"
            INSTALL_CMD="dnf install -y"
            ;;
        rhel|centos|rocky|almalinux|ol|scientific|amzn)
            PKG_FORMAT="rpm"
            # Use dnf if available, fall back to yum
            if command -v dnf >/dev/null 2>&1; then
                PKG_MANAGER="dnf"
                INSTALL_CMD="dnf install -y"
            else
                PKG_MANAGER="yum"
                INSTALL_CMD="yum install -y"
            fi
            ;;
        # SUSE family
        opensuse*|sles|suse)
            PKG_FORMAT="rpm"
            PKG_MANAGER="zypper"
            INSTALL_CMD="zypper install -y"
            ;;
        # Arch family (not officially supported, but try)
        arch|manjaro|endeavouros)
            warn "Arch-based distributions are not officially supported."
            warn "The .deb package may work with debtap, or use the tarball."
            PKG_FORMAT="deb"
            PKG_MANAGER="pacman"
            INSTALL_CMD="pacman -U --noconfirm"
            ;;
        *)
            # Try to detect from ID_LIKE
            case "$DISTRO_LIKE" in
                *debian*|*ubuntu*)
                    log "Detected Debian/Ubuntu derivative"
                    PKG_FORMAT="deb"
                    PKG_MANAGER="apt"
                    INSTALL_CMD="dpkg -i"
                    INSTALL_DEPS_CMD="apt-get install -f -y"
                    ;;
                *rhel*|*fedora*|*centos*)
                    log "Detected RHEL/Fedora derivative"
                    PKG_FORMAT="rpm"
                    if command -v dnf >/dev/null 2>&1; then
                        PKG_MANAGER="dnf"
                        INSTALL_CMD="dnf install -y"
                    else
                        PKG_MANAGER="yum"
                        INSTALL_CMD="yum install -y"
                    fi
                    ;;
                *suse*)
                    log "Detected SUSE derivative"
                    PKG_FORMAT="rpm"
                    PKG_MANAGER="zypper"
                    INSTALL_CMD="zypper install -y"
                    ;;
                *)
                    error "Unsupported distribution: $DISTRO\nSupported: Ubuntu, Debian, Fedora, RHEL, CentOS, Rocky, AlmaLinux, openSUSE, and derivatives"
                    ;;
            esac
            ;;
    esac

    log "Package format: $PKG_FORMAT (using $PKG_MANAGER)"
}

#=============================================================================
# Architecture Detection
#=============================================================================

detect_architecture() {
    ARCH=$(uname -m)

    case "$ARCH" in
        x86_64|amd64)
            DEB_ARCH="amd64"
            RPM_ARCH="x86_64"
            ;;
        aarch64|arm64)
            DEB_ARCH="arm64"
            RPM_ARCH="aarch64"
            ;;
        armv7l|armhf)
            DEB_ARCH="armhf"
            RPM_ARCH="armv7hl"
            warn "ARM 32-bit support is experimental"
            ;;
        *)
            error "Unsupported architecture: $ARCH\nSupported: x86_64, aarch64 (arm64)"
            ;;
    esac

    log "Architecture: $ARCH -> package arch: ${DEB_ARCH}/${RPM_ARCH}"
}

#=============================================================================
# Download and Install
#=============================================================================

download_package() {
    if [ "$PKG_FORMAT" = "deb" ]; then
        PKG_ARCH="$DEB_ARCH"
        PKG_NAME="allow2automate-agent-linux-${PKG_ARCH}-v${VERSION}.deb"
    else
        PKG_ARCH="$RPM_ARCH"
        PKG_NAME="allow2automate-agent-linux-${PKG_ARCH}-v${VERSION}.rpm"
    fi

    PKG_URL="${GITHUB_RELEASES}/v${VERSION}/${PKG_NAME}"
    PKG_PATH="/tmp/${PKG_NAME}"

    log "Downloading: $PKG_NAME"
    info "URL: $PKG_URL"

    # Download
    if [ "$DOWNLOAD_TOOL" = "curl" ]; then
        curl -fsSL -o "$PKG_PATH" "$PKG_URL" || {
            # Try alternative naming convention
            if [ "$PKG_FORMAT" = "deb" ]; then
                ALT_PKG_NAME="allow2automate-agent_${VERSION}_${PKG_ARCH}.deb"
            else
                ALT_PKG_NAME="allow2automate-agent-${VERSION}.${PKG_ARCH}.rpm"
            fi
            ALT_URL="${GITHUB_RELEASES}/v${VERSION}/${ALT_PKG_NAME}"
            warn "Primary URL failed, trying alternative: $ALT_PKG_NAME"
            curl -fsSL -o "$PKG_PATH" "$ALT_URL" || error "Download failed. Check version $VERSION exists at:\n  https://github.com/$REPO/releases"
        }
    else
        wget -q -O "$PKG_PATH" "$PKG_URL" || {
            if [ "$PKG_FORMAT" = "deb" ]; then
                ALT_PKG_NAME="allow2automate-agent_${VERSION}_${PKG_ARCH}.deb"
            else
                ALT_PKG_NAME="allow2automate-agent-${VERSION}.${PKG_ARCH}.rpm"
            fi
            ALT_URL="${GITHUB_RELEASES}/v${VERSION}/${ALT_PKG_NAME}"
            warn "Primary URL failed, trying alternative: $ALT_PKG_NAME"
            wget -q -O "$PKG_PATH" "$ALT_URL" || error "Download failed. Check version $VERSION exists at:\n  https://github.com/$REPO/releases"
        }
    fi

    # Verify download
    if [ ! -f "$PKG_PATH" ] || [ ! -s "$PKG_PATH" ]; then
        error "Downloaded file is empty or missing"
    fi

    log "Downloaded: $(ls -lh "$PKG_PATH" | awk '{print $5}')"
}

install_package() {
    log "Installing package..."

    case "$PKG_MANAGER" in
        apt)
            # dpkg may fail on dependencies, apt-get -f install fixes it
            dpkg -i "$PKG_PATH" || true
            apt-get install -f -y
            ;;
        dnf|yum)
            $INSTALL_CMD "$PKG_PATH"
            ;;
        zypper)
            zypper install -y --allow-unsigned-rpm "$PKG_PATH"
            ;;
        pacman)
            # For Arch, might need debtap first
            pacman -U --noconfirm "$PKG_PATH" 2>/dev/null || {
                warn "Direct pacman install failed. For Arch, consider using debtap or the tarball."
                error "Arch installation requires manual intervention"
            }
            ;;
        *)
            $INSTALL_CMD "$PKG_PATH"
            ;;
    esac

    # Cleanup
    rm -f "$PKG_PATH"
    log "Package installed successfully"
}

#=============================================================================
# Configuration
#=============================================================================

write_configuration() {
    CONFIG_DIR="/etc/allow2/agent"
    CONFIG_FILE="${CONFIG_DIR}/config.json"

    log "Writing configuration..."

    # Create config directory
    mkdir -p "$CONFIG_DIR"

    # Check if config already exists
    if [ -f "$CONFIG_FILE" ]; then
        BACKUP_FILE="${CONFIG_FILE}.backup.$(date +%Y%m%d%H%M%S)"
        warn "Existing config found, backing up to: $BACKUP_FILE"
        cp "$CONFIG_FILE" "$BACKUP_FILE"
    fi

    # Write new config
    echo "$AGENT_CONFIG" > "$CONFIG_FILE"

    # Secure permissions (only root can read)
    chmod 600 "$CONFIG_FILE"
    chown root:root "$CONFIG_FILE"

    log "Configuration written to: $CONFIG_FILE"
}

#=============================================================================
# Service Management
#=============================================================================

start_service() {
    SERVICE_NAME="allow2automate-agent"

    log "Configuring systemd service..."

    # Reload systemd to pick up the service file
    systemctl daemon-reload

    # Enable service to start on boot
    systemctl enable "$SERVICE_NAME" 2>/dev/null || warn "Could not enable service"

    # Start/restart the service
    log "Starting $SERVICE_NAME service..."
    if systemctl is-active --quiet "$SERVICE_NAME"; then
        systemctl restart "$SERVICE_NAME"
        log "Service restarted"
    else
        systemctl start "$SERVICE_NAME"
        log "Service started"
    fi

    # Wait a moment and verify
    sleep 2

    if systemctl is-active --quiet "$SERVICE_NAME"; then
        log "Service is running"
    else
        warn "Service may not have started correctly"
        warn "Check status with: systemctl status $SERVICE_NAME"
        warn "Check logs with: journalctl -u $SERVICE_NAME -f"
    fi
}

#=============================================================================
# Verification
#=============================================================================

verify_installation() {
    log ""
    log "============================================"
    log "  Installation Complete!"
    log "============================================"
    log ""

    # Extract agent ID from config for display
    AGENT_ID=$(echo "$AGENT_CONFIG" | grep -o '"agentId"[[:space:]]*:[[:space:]]*"[^"]*"' | cut -d'"' -f4)
    if [ -n "$AGENT_ID" ]; then
        log "Agent ID: $AGENT_ID"
    fi

    log "Version: $VERSION"
    log ""
    log "Useful commands:"
    info "  Status:    systemctl status allow2automate-agent"
    info "  Logs:      journalctl -u allow2automate-agent -f"
    info "  Stop:      sudo systemctl stop allow2automate-agent"
    info "  Start:     sudo systemctl start allow2automate-agent"
    info "  Restart:   sudo systemctl restart allow2automate-agent"
    info "  Uninstall: sudo /usr/local/share/allow2automate-agent/uninstall.sh"
    log ""
    log "Config file: /etc/allow2/agent/config.json"
    log ""
}

#=============================================================================
# Main
#=============================================================================

main() {
    echo ""
    log "============================================"
    log "  Allow2Automate Agent Installer v${VERSION}"
    log "============================================"
    echo ""

    # Pre-flight checks
    check_root
    check_systemd
    check_download_tool

    # Detection
    detect_distro
    detect_package_manager
    detect_architecture

    # Install
    download_package
    install_package
    write_configuration
    start_service

    # Done
    verify_installation
}

# Run main function
main "$@"
