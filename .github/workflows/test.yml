name: Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday
  workflow_dispatch: # Manual trigger

jobs:
  test-windows:
    name: Test on Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:coverage

      - name: Test process detection (Windows)
        shell: pwsh
        run: |
          node -e "
          import('./src/platform/windows/ProcessMonitor.js').then(m => {
            const monitor = new m.default();
            monitor.getRunningProcesses().then(procs => {
              console.log('Detected', procs.length, 'processes');
              process.exit(procs.length > 0 ? 0 : 1);
            });
          });
          "

      - name: Upload Windows test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-test-results
          path: coverage/
          retention-days: 30

  test-macos:
    name: Test on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:coverage

      - name: Test process detection (macOS)
        run: |
          node -e "
          import('./src/platform/macos/ProcessMonitor.js').then(m => {
            const monitor = new m.default();
            monitor.getRunningProcesses().then(procs => {
              console.log('Detected', procs.length, 'processes');
              process.exit(procs.length > 0 ? 0 : 1);
            });
          });
          "

      - name: Upload macOS test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-results
          path: coverage/
          retention-days: 30

  test-linux:
    name: Test on Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:coverage

      - name: Test process detection (Linux)
        run: |
          node -e "
          import('./src/platform/linux/ProcessMonitor.js').then(m => {
            const monitor = new m.default();
            monitor.getRunningProcesses().then(procs => {
              console.log('Detected', procs.length, 'processes');
              process.exit(procs.length > 0 ? 0 : 1);
            });
          });
          "

      - name: Upload Linux test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-test-results
          path: coverage/
          retention-days: 30

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-windows, test-macos, test-linux]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start agent service
        run: |
          npm start &
          AGENT_PID=$!
          echo "AGENT_PID=$AGENT_PID" >> $GITHUB_ENV
          sleep 5

      - name: Test API endpoints
        run: |
          # Test health endpoint
          response=$(curl -s http://localhost:3000/health)
          echo "Health check: $response"

          # Test status endpoint
          response=$(curl -s http://localhost:3000/api/status)
          echo "Status: $response"

          # Verify response contains expected fields
          if echo "$response" | grep -q "status"; then
            echo "API test passed"
          else
            echo "API test failed"
            exit 1
          fi

      - name: Test mDNS discovery
        run: |
          # Install dns-sd for mDNS testing
          sudo apt-get update
          sudo apt-get install -y avahi-utils

          # Give time for mDNS to advertise
          sleep 10

          # Try to discover the service
          timeout 15 avahi-browse -t _allow2agent._tcp || echo "mDNS test completed"

      - name: Test process monitoring
        run: |
          # Test that agent can detect processes
          response=$(curl -s http://localhost:3000/api/processes)
          echo "Processes: $response"

          if echo "$response" | grep -q "processes"; then
            echo "Process monitoring test passed"
          else
            echo "Process monitoring test failed"
            exit 1
          fi

      - name: Stop agent service
        if: always()
        run: |
          if [ ! -z "${{ env.AGENT_PID }}" ]; then
            kill ${{ env.AGENT_PID }} || true
          fi

      - name: Check logs
        if: always()
        run: |
          if [ -f logs/agent.log ]; then
            echo "=== Agent Logs ==="
            tail -n 50 logs/agent.log
          fi

  test-node-versions:
    name: Test Node.js Versions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 21]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for vulnerable dependencies
        run: |
          npm audit --json > audit-results.json || true
          cat audit-results.json || echo "No audit results available"

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit-results.json
          retention-days: 30

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-windows, test-macos, test-linux, integration-tests, test-node-versions, security-scan]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4

      - name: Generate test summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Platform Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Windows: ${{ needs.test-windows.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: ${{ needs.test-macos.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linux: ${{ needs.test-linux.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Node.js Versions" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.test-node-versions.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY

          if [ -f security-audit/audit-results.json ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Security Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat security-audit/audit-results.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
